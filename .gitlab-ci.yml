image: internal.docker.gda.allianz/docker-docker

stages:
  - build

.build_template: &build_env
  stage: build
  script:
    - set -eu
    - echo $DOCKER_CFG > ~/.dockercfg
    - export COMMIT="${CI_BUILD_REF:0:8}"
    - echo "${BASHRC}" > ~/.bashrc
    - export CONTAINER_TAG="internal.docker.gda.allianz/docker-zeppelin:${COMMIT}"
    - echo "building and pushing tag $CONTAINER_TAG"
    - sudo apt-get update
    - sudo apt-get -o Dpkg::Options::="--force-overwrite" install -y git
    - npm update npm -g
    - npm install -g bower grunt
    - ./build shiro
    - ./build download --zeppelin_version=$ZEPPELIN_VERSION --spark_version=$SPARK_VERSION --hadoop_version=$HADOOP_VERSION
    - ./build binary --zeppelin_version=$ZEPPELIN_VERSION --spark_version=$SPARK_VERSION --hadoop_version=$HADOOP_VERSION
    - ./build docker --repo=$REPO --commit=$COMMIT
#    - docker tag $CONTAINER_TAG $CONTAINER_TAG-z$ZEPPELIN_VERSION-s$SPARK_VERSION-h$HADOOP_VERSION
#    - docker push $REPO
  only:
    - master

build_zeppelin_0.8.1_spark_2.0.2_hadoop_2.7:
  <<: *build_env
  before_script:
    - export ZEPPELIN_VERSION=v0.8.1
    - export SPARK_VERSION=2.0.2
    - export HADOOP_VERSION=2.7

build_zeppelin_0.8.1_spark_2.1.1_hadoop_2.7:
  <<: *build_env
  before_script:
    - export ZEPPELIN_VERSION=v0.8.1
    - export SPARK_VERSION=2.1.1
    - export HADOOP_VERSION=2.7

#	language: java
#	sudo: required
#	services:
#		- docker
#	jdk:
#		- openjdk8
#
#	env:
#		matrix:
#			- SPARK_VERSION=2.0.2 HADOOP_VERSION=2.7
#			- SPARK_VERSION=2.1.1 HADOOP_VERSION=2.7
#			- SPARK_VERSION=2.2.0 HADOOP_VERSION=2.7
#			- SPARK_VERSION=2.2.2 HADOOP_VERSION=2.7
#			- SPARK_VERSION=2.4.3 HADOOP_VERSION=2.7
#			- SPARK_VERSION=2.4.4 HADOOP_VERSION=2.7
#			- SPARK_VERSION=2.4.5 HADOOP_VERSION=2.7
#			- SPARK_VERSION=2.4.6 HADOOP_VERSION=2.7
#			- SPARK_VERSION=2.4.7 HADOOP_VERSION=2.7
#			- SPARK_VERSION=3.0.0 HADOOP_VERSION=3.2
#
#	script:
#		- ./build $SPARK_VERSION $HADOOP_VERSION
#
#	after_success:
#		- docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
#		- export COMMIT=${TRAVIS_COMMIT::8}
#		- export REPO=datascienceplatform/dorkd
#		- export NICE_BRANCH_NAME=`if [ $TRAVIS_PULL_REQUEST == "false" ]; then echo $(echo $TRAVIS_BRANCH | sed -e 's/\//_/g'); else echo "PullRequest_$TRAVIS_PULL_REQUEST"; fi`
#		- export TAG=`if [ "$NICE_BRANCH_NAME" == "master" ]; then echo "latest"; else echo "$NICE_BRANCH_NAME" ; fi`
#		- docker build -t $REPO:$COMMIT .
#		- docker tag $REPO:$COMMIT $REPO:$TAG-s$SPARK_VERSION-h$HADOOP_VERSION
#		- docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER-s$SPARK_VERSION-h$HADOOP_VERSION
#		- docker tag $REPO:$COMMIT $REPO:$COMMIT-s$SPARK_VERSION-h$HADOOP_VERSION
#		- docker push $REPO
